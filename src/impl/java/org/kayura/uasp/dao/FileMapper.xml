<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.3//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kayura.uasp.dao.FileMapper">

	<!-- 文件存储关系持久化 -->

	<resultMap id="fileInfoMap" type="org.kayura.uasp.po.FileInfo">
		<id property="fileId" column="File_Id" />
		<result property="fileSize" column="FileSize" />
		<result property="contentType" column="ContentType" />
		<result property="logicPath" column="LogicPath" />
		<result property="md5" column="MD5" />
		<result property="allowChange" column="AllowChange" />
		<result property="isEncrypted" column="IsEncrypted" />
		<result property="salt" column="Salt" />
	</resultMap>

	<resultMap id="fileRelationMap" type="org.kayura.uasp.po.FileRelation">
		<id property="frId" column="Fr_Id" />
		<result property="fileId" column="File_Id" />
		<result property="tenantId" column="Tenant_Id" />
		<result property="bizId" column="BizId" />
		<result property="category" column="Category" />
		<result property="fileName" column="FileName" />
		<result property="postfix" column="Postfix" />
		<result property="uploaderId" column="UploaderId" />
		<result property="uploaderName" column="UploaderName" />
		<result property="uploadTime" column="UploadTime" />
		<result property="serial" column="Serial" />
		<result property="tags" column="Tags" />
	</resultMap>

	<resultMap id="fileFolderMap" type="org.kayura.uasp.po.FileFolder">
		<id property="folderId" column="Folder_Id" />
		<result property="tenantId" column="Tenant_Id" />
		<result property="parentId" column="Parent_Id" />
		<result property="creatorId" column="Creator_Id" />
		<result property="groupId" column="Group_Id" />
		<result property="groupName" column="GroupName" />
		<result property="name" column="Name" />
		<result property="hidden" column="Hidden" />
	</resultMap>

	<resultMap type="org.kayura.uasp.po.FileShare" id="fileShareMap">
		<id property="fileShareId" column="FileShare_Id" />
		<result property="sharerId" column="Sharer_Id" />
		<result property="sharerName" column="SharerName" />
		<result property="receiverId" column="Receiver_Id" />
		<result property="receiverName" column="ReceiverName" />
		<result property="folderId" column="Folder_Id" />
		<result property="folderName" column="FolderName" />
		<result property="frId" column="Fr_Id" />
		<result property="fileName" column="FileName" />
		<result property="createTime" column="CreateTime" />
	</resultMap>
	
	<!-- FileInfo -->

	<insert id="insertFileInfo" parameterType="org.kayura.uasp.po.FileInfo">
		INSERT UASP_FileInfos (
			File_Id,
			FileSize,
			ContentType,
			LogicPath,
			MD5,
			AllowChange,
			IsEncrypted,
			Salt
		) VALUES(
			#{fileId},
			#{fileSize},
			#{contentType},
			#{logicPath},
			#{md5},
			#{allowChange},
			#{isEncrypted},
			#{salt}
		)		
	</insert>
	
	<update id="updateFileInfo" parameterType="map">
		UPDATE UASP_FileInfos 
		<set>
			<if test="fileSize != null">
				FileSize = #{fileSize},
			</if>
			<if test="contentType != null">
				ContentType = #{contentType},
			</if>
			<if test="md5 != null">
				MD5 = #{md5},
			</if>
			<if test="allowChange != null">
				AllowChange = #{allowChange},
			</if>
		</set>
		WHERE ( File_Id = #{fileId} )
	</update>

	<select id="getFileInfoById" parameterType="string" resultMap="fileInfoMap">
		SELECT
			t.File_Id,
			t.FileSize,
			t.ContentType,
			t.LogicPath,
			t.MD5,
			t.AllowChange,
			t.IsEncrypted,
			t.Salt
		FROM UASP_FileInfos t
		WHERE ( t.File_Id = #{value} )
	</select>
	
	<select id="getFileInfoKeyByMd5" parameterType="string" resultType="string">
		SELECT t.File_Id FROM UASP_FileInfos t
		WHERE ( t.MD5 = #{value} ) 
	</select>

	<select id="fileInfoExistsByMap" parameterType="map" resultType="boolean">
		SELECT COUNT(1) > 0 FROM UASP_FileInfos t
		<where>
			<if test="fileId != null">
				AND ( t.File_Id = #{fileId} )
			</if>
			<if test="md5 != null">
				AND ( t.MD5 = #{md5} )
			</if>
		</where>
	</select>
	
	<!-- FileRelation -->

	<insert id="insertFileRelation" parameterType="org.kayura.uasp.po.FileRelation">
		INSERT UASP_FileRelations (
			Fr_Id,
			File_Id,
			Tenant_Id,
			BizId,
			Category,
			FileName,
			Postfix,
			UploaderId,
			UploaderName,
			UploadTime,
			Serial,
			Tags
		) VALUES (
			#{frId},
			#{fileId},
			#{tenantId},
			#{bizId},
			#{category},
			#{fileName},
			#{postfix},
			#{uploaderId},
			#{uploaderName},
			#{uploadTime},
			#{serial},
			#{tags}
		)			
	</insert>
	
	<update id="updateFileRelation" parameterType="map">
		UPDATE UASP_FileRelations 
		<set>
			<if test="category != null">
				Category = #{category},
			</if>
			<if test="fileName != null">
				FileName = #{fileName},
			</if>
			<if test="postfix != null">
				Postfix = #{postfix},
			</if>
			<if test="uploadTime != null">
				UploadTime = #{uploadTime},
			</if>
			<if test="serial != null">
				Serial = #{serial},
			</if>
			<if test="tags != null">
				Tags = #{tags},
			</if>
		</set>
		WHERE ( Fr_Id = #{frId} )
	</update>
	
	<sql id="fileRelationColumns">
		t.Fr_Id,
		t.File_Id,
		t.Tenant_Id,
		t.BizId,
		t.Category,
		t.FileName,
		t.Postfix,
		t.UploaderId,
		t.UploaderName,
		t.UploadTime,
		t.Serial,
		t.Tags
	</sql>
	
	<select id="getFileRelationById" parameterType="string" resultMap="fileRelationMap">
		SELECT 
			<include refid="fileRelationColumns" />
		FROM UASP_FileRelations t
		WHERE ( t.Fr_Id = #{value} )
	</select>

	<resultMap id="fileListItemMap" type="org.kayura.uasp.vo.FileListItem">
		<id property="frId" column="Fr_Id" />
		<result property="fileName" column="FileName" />
		<result property="fileSize" column="FileSize" />
		<result property="postfix" column="Postfix" />
		<result property="uploaderId" column="UploaderId" />
		<result property="uploaderName" column="UploaderName" />
		<result property="uploadTime" column="UploadTime" />
		<result property="downloads" column="Downloads" />
		<result property="allowChange" column="AllowChange" />
		<result property="isEncrypted" column="IsEncrypted" />
	</resultMap>
		
	<select id="findFiles" parameterType="map" resultMap="fileListItemMap">
		SELECT
			t.Fr_Id,
			t.FileName,
			i.FileSize,
			t.Postfix,
			t.UploaderId,
			t.UploaderName,
			t.UploadTime,
			t.Downloads,
			i.AllowChange,
			i.IsEncrypted
		FROM uasp_filerelations AS t
			INNER JOIN uasp_fileinfos AS i ON t.File_Id = i.File_Id
			<if test="sharerId != null or receiverId != null">
			INNER JOIN uasp_fileshares AS s ON s.Fr_Id = t.Fr_Id
			</if>
		<where>
			<if test="folderId != null and folderId != 'NULL'">
				AND ( t.Folder_Id = #{folderId} )
			</if>
			<if test="folderId == 'NULL'">
				AND ( t.Folder_Id IS NULL ) 
			</if>
			<if test="uploaderId != null">
				AND ( t.UploaderId = #{uploaderId} )
			</if>
			<if test="sharerId != null or receiverId != null">
				AND ( s.Folder_Id IS NULL ) 
			</if>
			<if test="sharerId != null">
				AND ( s.Sharer_Id = #{sharerId} )
			</if>
			<if test="receiverId != null">
				AND ( s.Receiver_Id = #{receiverId} )
			</if>
			<if test="bizId != null">
				AND ( t.BizId = #{bizId} )
			</if>
			<if test="tag != null">
				AND ( t.Tags LIKE #{tag} )
			</if>
		</where>
		ORDER BY t.Serial ASC
	</select>
		
	<update id="incrementDownloads" parameterType="string" >
		UPDATE UASP_FileRelations SET Downloads = Downloads + 1 WHERE ( Fr_Id = #{value} )
	</update>
		
	<select id="getFileRelationTagsById" parameterType="string" resultType="string">
		SELECT t.Tags FROM UASP_FileRelations t
		WHERE ( t.Fr_Id = #{value} )
	</select>
	
	<select id="findFileRelationsByMap" parameterType="map" resultMap="fileRelationMap">
		SELECT 
			<include refid="fileRelationColumns" />
		FROM UASP_FileRelations t
		<where>
			<if test="fileId != null">
				AND ( t.File_Id = #{fileId} )
			</if>
			<if test="bizId != null">
				AND ( t.BizId = #{bizId} )
			</if>
			<if test="category != null">
				AND ( t.Category = #{category} )
			</if>
			<if test="uploader != null">
				AND ( t.UploaderId = #{uploader} OR t.UploaderName = #{uploader} )
			</if>
			<if test="tags != null">
				AND ( t.Tags LIKE #{tags} )
			</if>
		</where>
	</select>
	
	<select id="getFolders" parameterType="map" resultMap="fileFolderMap">
		SELECT
			t.Folder_Id,
			t.Tenant_Id,
			t.Parent_Id,
			t.Creator_Id,
			t.Group_Id,
			g.Name GroupName,
			t.`Name`,
			t.Hidden
		FROM uasp_filefolders AS t
			LEFT JOIN uasp_groups g ON g.Group_Id = t.Group_Id
		<where>
			<if test="tenantId = 'NULL' and userId == null">
				(t.Tenant_Id IS NULL)
			</if>
			<if test="userId != null">
				((t.Tenant_Id IS NULL) AND (Hidden = 0) ) OR
				((t.Creator_Id = #{userId}) AND (t.Group_Id IS NULL) ) OR 
				((t.Group_Id IS NOT NULL) AND (Hidden = 0) AND EXISTS (
				   SELECT 1 FROM uasp_groupusers_union u WHERE u.Group_Id = t.Group_Id AND u.User_Id = #{userId} 
				))
			</if>
		</where>
	</select>
	
	<select id="getFileShares" parameterType="map" resultMap="fileShareMap">
		SELECT
			t.FileShare_Id,
			t.Sharer_Id,
			<if test="receiverId != null">
			s.DisplayName AS SharerName,
			</if>
			t.Receiver_Id,
			<if test="sharerId != null">
			r.DisplayName AS ReceiverName,
			</if>
			t.Folder_Id,
			<if test="findType == null or findType == 'FOLDER' ">
			f.Name FolderName,
			</if>
			t.Fr_Id,
			<if test="findType == null or findType == 'FILE' ">
			c.FileName,
			</if>
			t.CreateTime
		FROM uasp_fileshares AS t
		<if test="sharerId != null">
		LEFT JOIN uasp_users AS r ON t.Receiver_Id = r.User_Id
		</if>
		<if test="receiverId != null">
		LEFT JOIN uasp_users AS s ON t.Sharer_Id = s.User_Id
		</if>
		<if test="findType == null or findType == 'FOLDER' ">
		LEFT JOIN uasp_filefolders AS f ON t.Folder_Id = f.Folder_Id
		</if>
		<if test="findType == null or findType == 'FILE' ">
		LEFT JOIN uasp_filerelations AS c ON t.Fr_Id = c.Fr_Id
		</if>
		<where>
			<if test="sharerId != null">
				AND ( t.Sharer_Id = #{sharerId} )
			</if>
			<if test="receiverId != null">
				AND ( t.Receiver_Id = #{receiverId} )
			</if>
			<if test="findType == 'FOLDER' ">
				AND ( t.Folder_Id IS NOT NULL )
			</if>
			<if test="findType == 'FILE' ">
				AND ( t.Fr_Id IS NOT NULL )
			</if>
		</where>
	</select>
	
</mapper>